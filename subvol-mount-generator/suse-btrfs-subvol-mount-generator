#!/bin/bash
output="${1:?}"

declare -A mountpoints
# the list of potential mount points we may need to generate a unit for
for i in /var /usr/local /srv /root /opt /home /.snapshots; do mountpoints["$i"]=""; done

root_uuid=$(findmnt / -r -n -o UUID)
quoted_uuid="${root_uuid//-/\\x2d}"
dev="/dev/disk/by-uuid/$root_uuid"

declare -a line
# remove existing fstab entries from the list of mounts to generate
while read -r -a line; do
	[ "${line[0]###}" = "${line[0]}" ] || continue
	path="${line[1]}"
	[ -v "mountpoints[$path]" ] || continue
	unset "mountpoints[$path]"
done < /etc/fstab
# finally read subvolumes and generate units for the mountpoints we are are interested in
while read -r -a line; do
	subvol="/${line[8]}"
	path="${line[8]#@/}"
	[ "$path" != "${line[8]}" ] || continue
	[ -v "mountpoints[/$path]" ] || continue
	name="$(systemd-escape -p "/$path").mount"
	[ -e "$output/$name" ] && continue
	cat > "$output/$name" <<-EOF
	# Automatically generated by ${0##*/}

	[Unit]
	Documentation=man:fstab(5) man:${0##*/}(8)
	Before=local-fs.target
	After=blockdev@dev-disk-by\\x2duuid-$quoted_uuid.target

	[Mount]
	What=$dev
	Where=/$path
	Type=btrfs
	Options=subvol=$subvol
	EOF

	mkdir -p "$output/local-fs.target.requires"
	ln -s "../$name" "$output/local-fs.target.requires"
done < <(btrfs subvol list /)
